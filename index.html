<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OnTop AI Chat</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

// O componente de Ícones permanece o mesmo do seu código original...
function Icon({ name, className = "", size = 20 }) {
    const icons = {
        Menu: () => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>),
        X: () => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>),
        Settings: () => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>),
        LogOut: () => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>),
        Send: () => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>),
        Plus: () => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>),
        MessageSquare: () => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>),
        Lightbulb: () => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15 14c.2-1 .7-1.7 1.5-2.5C17.7 10.2 18 9 18 7.5a6 6 0 0 0-12 0c0 1.5.3 2.7 1.5 3.5.7.8 1.2 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>),
        User: () => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>),
        ChevronDown: () => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 12 15 18 9"></polyline></svg>),
        ChevronRight: () => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 18 15 12 9 6"></polyline></svg>),
        MoreHorizontal: () => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>),
        Share2: () => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>),
        Folder: () => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L8.6 3.3A2 2 0 0 0 6.9 2H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2Z"></path></svg>),
        FolderPlus: () => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L8.6 3.3A2 2 0 0 0 6.9 2H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2Z"></path><line x1="12" y1="10" x2="12" y2="16"></line><line x1="9" y1="13" x2="15" y2="13"></line></svg>),
        Archive: () => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg>),
        Flag: () => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg>),
        Trash2: () => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>),
        Edit: () => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>),
        Pin: () => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>),
    };
    const IconComponent = icons[name];
    return IconComponent ? <IconComponent /> : null;
}

function ChatInterface() {
    const [inputValue, setInputValue] = useState("");
    const [isLoading, setIsLoading] = useState(false);
    const [sidebarOpen, setSidebarOpen] = useState(window.innerWidth >= 1024);
    const [selectedLanguage, setSelectedLanguage] = useState("PT");
    const [isAccountOpen, setAccountOpen] = useState(false);
    
    // =================================================================
    // ESTADO REESTRUTURADO PARA SUPORTAR PROJETOS E CHATS ANINHADOS
    // =================================================================
    
    // Objeto contendo todos os chats
    const [chats, setChats] = useState(() => {
        const saved = localStorage.getItem('ontop-ai-chats');
        return saved ? JSON.parse(saved) : {};
    });

    // Array de objetos de projetos
    const [projects, setProjects] = useState(() => {
        const saved = localStorage.getItem('ontop-ai-projects');
        // Adiciona um projeto "Geral" se não houver nenhum
        if (!saved || JSON.parse(saved).length === 0) {
            return [{ id: 'proj_default', name: 'Geral', pinned: false, chatIds: [] }];
        }
        return JSON.parse(saved);
    });

    // IDs para controlar o estado da UI
    const [currentChatId, setCurrentChatId] = useState(null);
    const [selectedProjectId, setSelectedProjectId] = useState(() => {
        const savedProjects = JSON.parse(localStorage.getItem('ontop-ai-projects'));
        return savedProjects?.[0]?.id || 'proj_default';
    });
    const [renamingChatId, setRenamingChatId] = useState(null);
    const [renamingProjectId, setRenamingProjectId] = useState(null);
    const [activeMenu, setActiveMenu] = useState({ type: null, id: null }); // { type: 'chat' | 'project', id: string }
    
    // Refs para fechar menus ao clicar fora
    const menuRef = useRef(null);
    const messagesEndRef = useRef(null);

    // Efeitos para salvar no localStorage
    useEffect(() => {
        localStorage.setItem('ontop-ai-chats', JSON.stringify(chats));
    }, [chats]);

    useEffect(() => {
        localStorage.setItem('ontop-ai-projects', JSON.stringify(projects));
    }, [projects]);

    // Efeito para responsividade da sidebar
    useEffect(() => {
        const handleResize = () => setSidebarOpen(window.innerWidth >= 1024);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
    }, []);

    // Efeito para fechar menus
    useEffect(() => {
        const handleClickOutside = (event) => {
            if (menuRef.current && !menuRef.current.contains(event.target)) {
                setActiveMenu({ type: null, id: null });
            }
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);
    
    const scrollToBottom = () => messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    useEffect(scrollToBottom, [chats[currentChatId]?.messages]);
    
    // =================================================================
    // FUNÇÕES DE MANIPULAÇÃO (HANDLERS)
    // =================================================================
    
    // ---- Funções de Projeto ----
    const handleCreateNewProject = () => {
        const newProject = {
            id: `proj_${Date.now()}`,
            name: `Novo Projeto ${projects.length + 1}`,
            pinned: false,
            chatIds: []
        };
        setProjects(prev => [...prev, newProject]);
        setSelectedProjectId(newProject.id);
    };

    const handleDeleteProject = (projectIdToDelete) => {
        if (projects.length === 1) {
            alert("Não é possível excluir o último projeto.");
            return;
        }
        
        // Remove os chats associados ao projeto
        const projectToDelete = projects.find(p => p.id === projectIdToDelete);
        if (projectToDelete) {
            setChats(prevChats => {
                const newChats = { ...prevChats };
                projectToDelete.chatIds.forEach(chatId => {
                    delete newChats[chatId];
                });
                return newChats;
            });
        }
        
        // Remove o projeto e seleciona outro
        setProjects(prev => {
            const newProjects = prev.filter(p => p.id !== projectIdToDelete);
            if (selectedProjectId === projectIdToDelete) {
                setSelectedProjectId(newProjects[0]?.id || null);
            }
            return newProjects;
        });
        setActiveMenu({ type: null, id: null });
    };

    const handleRenameProject = (projectId, newName) => {
        if (!newName.trim()) return;
        setProjects(prev => prev.map(p => p.id === projectId ? { ...p, name: newName } : p));
        setRenamingProjectId(null);
        setActiveMenu({ type: null, id: null });
    };
    
    const handleTogglePinProject = (projectId) => {
        setProjects(prev => prev.map(p => p.id === projectId ? { ...p, pinned: !p.pinned } : p));
        setActiveMenu({ type: null, id: null });
    };

    // ---- Funções de Chat ----
    const startNewChat = () => {
        setCurrentChatId(null);
    };

    const handleDeleteChat = (chatIdToDelete) => {
        // Remove o chat do objeto de chats
        setChats(prev => {
            const newChats = { ...prev };
            delete newChats[chatIdToDelete];
            return newChats;
        });
        
        // Remove o ID do chat do projeto correspondente
        setProjects(prev => prev.map(proj => ({
            ...proj,
            chatIds: proj.chatIds.filter(id => id !== chatIdToDelete)
        })));
        
        if (currentChatId === chatIdToDelete) {
            setCurrentChatId(null);
        }
        setActiveMenu({ type: null, id: null });
    };

    const handleRenameChat = (chatId, newTitle) => {
        if (newTitle.trim() === '') return;
        setChats(prev => ({ ...prev, [chatId]: { ...prev[chatId], title: newTitle } }));
        setRenamingChatId(null);
        setActiveMenu({ type: null, id: null });
    };

    const handleTogglePinChat = (chatId) => {
        setChats(prev => ({ ...prev, [chatId]: { ...prev[chatId], pinned: !prev[chatId].pinned } }));
        setActiveMenu({ type: null, id: null });
    };

    const handleArchiveChat = (chatId) => {
        setChats(prev => ({ ...prev, [chatId]: { ...prev[chatId], archived: true } }));
        if (currentChatId === chatId) setCurrentChatId(null);
        alert(`Chat "${chats[chatId].title}" arquivado.`);
    };

    const handleShareChat = () => {
        if (!currentChatId || !chats[currentChatId]) {
            alert("Nenhum chat selecionado para compartilhar.");
            return;
        }
        const conversationText = chats[currentChatId].messages
            .map(msg => `${msg.type === 'user' ? 'Você' : 'OnTop AI'}: ${msg.content}`)
            .join('\n\n');
        
        navigator.clipboard.writeText(conversationText)
            .then(() => alert("Conversa copiada para a área de transferência!"))
            .catch(err => alert("Falha ao copiar a conversa."));
    };


    const handleSendMessage = async () => {
        if (!inputValue.trim()) return;

        // VERIFICA SE UM PROJETO ESTÁ SELECIONADO
        if (!selectedProjectId) {
            alert("Por favor, selecione ou crie um projeto antes de iniciar um chat.");
            return;
        }

        const userMessage = { id: `msg_${Date.now()}`, type: "user", content: inputValue, timestamp: new Date() };
        const query = inputValue;
        setInputValue("");
        
        let chatId = currentChatId;

        if (!chatId) { // Se for um novo chat
            chatId = `chat_${Date.now()}`;
            const newChat = {
                title: query.substring(0, 30) + (query.length > 30 ? '...' : ''),
                messages: [userMessage],
                pinned: false,
                archived: false
            };
            
            // Adiciona o novo chat ao estado de chats
            setChats(prev => ({ ...prev, [chatId]: newChat }));

            // Associa o novo chat ao projeto selecionado
            setProjects(prev => prev.map(p =>
                p.id === selectedProjectId ? { ...p, chatIds: [...p.chatIds, chatId] } : p
            ));
            
            setCurrentChatId(chatId);
        } else { // Se for um chat existente
            setChats(prev => ({
                ...prev,
                [chatId]: {
                    ...prev[chatId],
                    messages: [...prev[chatId].messages, userMessage]
                }
            }));
        }

        setIsLoading(true);
        try {
            // =================================================================
            // >> IMPORTANTE: COLOQUE SUA CHAVE DE API AQUI <<
            // =================================================================
            const apiKey = "AIzaSyBGP7HzJEXjUsztybC7GMdX0BiX3HQILR0"; // <--- SUA CHAVE DA API DO GEMINI VAI AQUI
            if (!apiKey) {
                throw new Error("API Key is missing. Please add your Gemini API key.");
            }
            // =================================================================

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            const systemPrompt = "You are OnTop AI, a helpful corporate intelligence assistant. Provide clear, concise, and professional answers.";
            
            const payload = {
                contents: [{ parts: [{ text: query }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                console.error("API Error Response:", errorBody);
                throw new Error(`API Error: ${response.statusText} - ${errorBody.error?.message}`);
            }

            const result = await response.json();
            const assistantText = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (assistantText) {
                const assistantMessage = { id: `msg_${Date.now()}_ai`, type: "assistant", content: assistantText, timestamp: new Date() };
                setChats(prev => ({
                    ...prev,
                    [chatId]: { ...prev[chatId], messages: [...(prev[chatId]?.messages || []), assistantMessage] }
                }));
            } else {
                throw new Error("No content received from API.");
            }
        } catch (error) {
            console.error("Failed to fetch from Gemini API:", error);
            const errorMessage = { id: `msg_${Date.now()}_err`, type: "assistant", content: `Desculpe, ocorreu um erro: ${error.message}. Verifique o console para mais detalhes.`, timestamp: new Date() };
            setChats(prev => ({
                ...prev,
                [chatId]: { ...prev[chatId], messages: [...(prev[chatId]?.messages || []), errorMessage] }
            }));
        } finally {
            setIsLoading(false);
        }
    };

    // =================================================================
    // DADOS PARA RENDERIZAÇÃO
    // =================================================================
    const texts = {
        EN: { typing: "OnTop AI is typing...", placeholder: "Ask about reports, HR data, sales...", newChat: "New Chat", chats: "Chats", settings: "Settings", signOut: "Sign Out", myAccount: "My Account", welcome: "How can I help you today?", suggestions: "Suggestions to get started", online: "Online", share: "Share", addToProject: "Add to project", archive: "Archive", report: "Report", delete: "Delete", projects: "Projects", newProject: "New project", alerts: "Alerts", queries: "Queries", rename: "Rename", pin: "Pin", unpin: "Unpin"},
        PT: { typing: "OnTop AI está a digitar...", placeholder: "Pergunte sobre relatórios, dados de RH...", newChat: "Novo Chat", chats: "Conversas", settings: "Configurações", signOut: "Sair", myAccount: "Minha Conta", welcome: "Como posso ajudar hoje?", suggestions: "Sugestões para começar", online: "Online", share: "Compartilhar", addToProject: "Adicionar ao projeto", archive: "Arquivar", report: "Denunciar", delete: "Excluir", projects: "Projetos", newProject: "Novo projeto", alerts: "Alertas", queries: "Consultas", rename: "Renomear", pin: "Fixar", unpin: "Desafixar"},
        ES: { typing: "OnTop AI está escribiendo...", placeholder: "Pregunta sobre informes, datos de RRHH...", newChat: "Nuevo Chat", chats: "Chats", settings: "Configuración", signOut: "Cerrar Sesión", myAccount: "Mi Cuenta", welcome: "¿Cómo puedo ayudarte hoy?", suggestions: "Sugerencias para empezar", online: "En línea", share: "Compartir", addToProject: "Añadir al proyecto", archive: "Archivar", report: "Denunciar", delete: "Eliminar", projects: "Projetos", newProject: "Nuevo proyecto", alerts: "Alertas", queries: "Consultas", rename: "Renombrar", pin: "Fijar", unpin: "Desfijar"},
    };
    const quickQuestions = {
        EN: ["Show latest sales report", "How many active employees do we have?", "Show Q3 performance metrics", "List database tables"],
        PT: ["Mostrar último relatório de vendas", "Quantos colaboradores ativos temos?", "Mostrar métricas de performance Q3", "Listar tabelas do banco de dados"],
        ES: ["Mostrar último informe de ventas", "¿Cuántos empleados activos tenemos?", "Mostrar métricas de rendimiento Q3", "Listar tablas de base de datos"],
    };
    const languages = [{ code: "EN", name: "English" }, { code: "PT", name: "Português" }, { code: "ES", name: "Español" }];

    const currentTexts = texts[selectedLanguage];
    const messages = chats[currentChatId]?.messages || [];
    
    // Filtra os chats com base no projeto selecionado
    const currentProject = projects.find(p => p.id === selectedProjectId);
    const visibleChatIds = currentProject ? currentProject.chatIds : [];
    
    const conversations = visibleChatIds
        .map(chatId => ({ id: chatId, ...chats[chatId] }))
        .filter(conv => conv && !conv.archived) // Filtra chats arquivados
        .sort((a, b) => (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0) || b.id.localeCompare(a.id));

    const sortedProjects = [...projects].sort((a, b) => (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0));

    return (
        <div className="flex h-screen bg-slate-50 text-slate-800 relative overflow-hidden">
            {sidebarOpen && <div onClick={() => setSidebarOpen(false)} className="fixed inset-0 bg-black/40 z-20 lg:hidden"></div>}

            <aside className={`bg-gradient-to-b from-slate-900 via-slate-800 to-purple-900 text-white transform transition-transform duration-300 ease-in-out fixed inset-y-0 left-0 z-30 w-64 flex flex-col ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                {/* Header da Sidebar */}
                <div className="p-4 flex items-center justify-between">
                    <div className="flex items-center gap-2">
                        <img src="https://i.imgur.com/KIIbI8A.png" alt="OnTop AI Logo" className="h-8 w-8" />
                        <h1 className="text-lg font-bold bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">OnTop AI</h1>
                    </div>
                    <button onClick={() => setSidebarOpen(false)} className="p-1 hover:bg-slate-700 rounded lg:hidden"><Icon name="X" size={20} /></button>
                </div>
                
                {/* Conteúdo da Sidebar */}
                <div className="flex-1 overflow-y-auto px-4 pb-4">
                    <button onClick={startNewChat} className="w-full flex items-center justify-center gap-2 p-2.5 my-2 bg-gradient-to-r from-purple-500 to-blue-500 rounded-lg text-sm font-semibold hover:from-purple-600 hover:to-blue-600 transition-all shadow-md"><Icon name="Plus" size={16}/>{currentTexts.newChat}</button>
                    
                    {/* Seção de Projetos */}
                    <div className="my-4">
                        <div className="flex items-center justify-between px-2 mb-2">
                            <h3 className="text-xs font-semibold tracking-wider text-gray-400 uppercase">{currentTexts.projects}</h3>
                            <button onClick={handleCreateNewProject} className="p-1 text-gray-400 hover:text-white hover:bg-slate-700/50 rounded-md">
                                <Icon name="FolderPlus" size={16}/>
                            </button>
                        </div>
                        {sortedProjects.map((project) => (
                            <div key={project.id} className="group relative">
                                <button
                                    onClick={() => { setSelectedProjectId(project.id); setCurrentChatId(null); }}
                                    className={`w-full flex items-center gap-3 p-2 text-left text-sm rounded-lg transition-colors ${selectedProjectId === project.id ? 'bg-purple-500/30 text-white' : 'text-gray-300 hover:bg-slate-700/50'}`}
                                >
                                    {project.pinned && <Icon name="Pin" size={14} className="text-purple-400" />}
                                    {renamingProjectId === project.id ? (
                                        <input
                                            type="text" defaultValue={project.name} autoFocus
                                            className="bg-transparent text-white w-full focus:outline-none"
                                            onKeyDown={(e) => { if (e.key === 'Enter') handleRenameProject(project.id, e.target.value); if (e.key === 'Escape') setRenamingProjectId(null);}}
                                            onBlur={(e) => handleRenameProject(project.id, e.target.value)}
                                        />
                                    ) : (
                                        <span className="flex-1 truncate">{project.name}</span>
                                    )}
                                    <span className="px-2 py-0.5 text-xs font-semibold bg-slate-700 rounded-full">{project.chatIds.length}</span>
                                </button>
                                <div className="absolute right-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onClick={() => setActiveMenu({type: 'project', id: project.id})} className="p-1 rounded-md hover:bg-slate-600"><Icon name="MoreHorizontal" size={16} /></button>
                                    {activeMenu.type === 'project' && activeMenu.id === project.id && (
                                        <div ref={menuRef} className="absolute right-0 bottom-full mb-1 w-32 bg-slate-800 rounded-md shadow-lg z-10 border border-slate-700">
                                            <button onClick={() => { setRenamingProjectId(project.id); setActiveMenu({type: null, id: null}); }} className="w-full text-left px-3 py-1.5 text-xs text-gray-300 hover:bg-slate-700 flex items-center gap-2"><Icon name="Edit" size={14}/>{currentTexts.rename}</button>
                                            <button onClick={() => handleTogglePinProject(project.id)} className="w-full text-left px-3 py-1.5 text-xs text-gray-300 hover:bg-slate-700 flex items-center gap-2"><Icon name="Pin" size={14}/>{project.pinned ? currentTexts.unpin : currentTexts.pin}</button>
                                            <div className="border-t border-slate-700 my-1"></div>
                                            <button onClick={() => handleDeleteProject(project.id)} className="w-full text-left px-3 py-1.5 text-xs text-red-400 hover:bg-red-800/50 flex items-center gap-2"><Icon name="Trash2" size={14}/>{currentTexts.delete}</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    {/* Seção de Chats */}
                    <div>
                        <h3 className="px-2 mb-2 text-xs font-semibold tracking-wider text-gray-400 uppercase">{currentTexts.chats}</h3>
                        {conversations.map((conv) => (
                            <div key={conv.id} className="group relative">
                                <button onClick={() => setCurrentChatId(conv.id)} className={`w-full flex items-center gap-2 text-left p-2 text-sm truncate transition-all rounded-lg ${currentChatId === conv.id ? 'bg-slate-700' : 'text-gray-300 hover:bg-slate-700/50'}`}>
                                    {conv.pinned && <Icon name="Pin" size={14} className="text-purple-400" />}
                                    {renamingChatId === conv.id ? (
                                        <input
                                            type="text" defaultValue={conv.title} autoFocus
                                            className="bg-transparent text-white w-full focus:outline-none"
                                            onKeyDown={(e) => { if (e.key === 'Enter') handleRenameChat(conv.id, e.target.value); if (e.key === 'Escape') setRenamingChatId(null);}}
                                            onBlur={(e) => handleRenameChat(conv.id, e.target.value)}
                                        />
                                    ) : (
                                        <span className="flex-1 truncate">{conv.title}</span>
                                    )}
                                </button>
                                <div className="absolute right-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onClick={() => setActiveMenu({type: 'chat', id: conv.id})} className="p-1 rounded-md hover:bg-slate-600"><Icon name="MoreHorizontal" size={16} /></button>
                                    {activeMenu.type === 'chat' && activeMenu.id === conv.id && (
                                        <div ref={menuRef} className="absolute right-0 bottom-full mb-1 w-32 bg-slate-800 rounded-md shadow-lg z-10 border border-slate-700">
                                            <button onClick={() => { setRenamingChatId(conv.id); setActiveMenu({type: null, id: null}); }} className="w-full text-left px-3 py-1.5 text-xs text-gray-300 hover:bg-slate-700 flex items-center gap-2"><Icon name="Edit" size={14}/>{currentTexts.rename}</button>
                                            <button onClick={() => handleTogglePinChat(conv.id)} className="w-full text-left px-3 py-1.5 text-xs text-gray-300 hover:bg-slate-700 flex items-center gap-2"><Icon name="Pin" size={14}/>{conv.pinned ? currentTexts.unpin : currentTexts.pin}</button>
                                            <div className="border-t border-slate-700 my-1"></div>
                                            <button onClick={() => handleDeleteChat(conv.id)} className="w-full text-left px-3 py-1.5 text-xs text-red-400 hover:bg-red-800/50 flex items-center gap-2"><Icon name="Trash2" size={14}/>{currentTexts.delete}</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>

                {/* Footer da Sidebar */}
                <div className="p-4 mt-auto border-t border-slate-700/50">
                    <button onClick={() => setAccountOpen(!isAccountOpen)} className="w-full flex items-center justify-between p-2 hover:bg-slate-700/50 rounded-lg text-left text-sm">
                        <div className="flex items-center"><Icon name="User" size={16} className="mr-3 text-gray-400" />{currentTexts.myAccount}</div>
                        <Icon name="ChevronDown" size={16} className={`transition-transform ${isAccountOpen ? 'rotate-180' : ''}`} />
                    </button>
                    {isAccountOpen && (
                        <div className="pl-5 pt-2 space-y-2">
                            <button className="w-full flex items-center p-2 hover:bg-slate-700/50 rounded-lg text-left text-sm"><Icon name="Settings" size={16} className="mr-3 text-gray-400" />{currentTexts.settings}</button>
                            <button className="w-full flex items-center p-2 hover:bg-red-800/50 rounded-lg text-left text-sm text-red-400"><Icon name="LogOut" size={16} className="mr-3" />{currentTexts.signOut}</button>
                        </div>
                    )}
                </div>
            </aside>
            
            {/* Conteúdo Principal */}
            <main className={`flex-1 flex flex-col transition-all duration-300 ease-in-out ${sidebarOpen ? 'lg:ml-64' : 'lg:ml-0'}`}>
                <header className="bg-white/80 border-b border-slate-200 p-4 flex items-center justify-between">
                    <div className="flex items-center gap-2">
                        <button onClick={() => setSidebarOpen(!sidebarOpen)} className="p-2 hover:bg-slate-100 rounded-lg text-slate-600"><Icon name="Menu" size={20} /></button>
                        <h2 className="text-base font-semibold text-purple-600">{currentProject?.name || "Selecione um Projeto"}</h2>
                    </div>
                    <div className="flex items-center space-x-2">
                        <select onChange={(e) => setSelectedLanguage(e.target.value)} value={selectedLanguage} className="text-sm appearance-none bg-slate-100 border border-slate-200 rounded-md py-1.5 pl-3 pr-8 text-slate-700 focus:outline-none focus:ring-2 focus:ring-purple-400">
                            {languages.map(lang => <option key={lang.code} value={lang.code}>{lang.name}</option>)}
                        </select>
                        <button onClick={handleShareChat} className="p-2 flex items-center gap-2 hover:bg-slate-100 rounded-lg text-slate-600 text-sm">
                            <Icon name="Share2" size={16} /> <span className="hidden md:inline">{currentTexts.share}</span>
                        </button>
                        <button onClick={() => handleArchiveChat(currentChatId)} className="p-2 flex items-center gap-2 hover:bg-slate-100 rounded-lg text-slate-600 text-sm">
                            <Icon name="Archive" size={16} /> <span className="hidden md:inline">{currentTexts.archive}</span>
                        </button>
                    </div>
                </header>

                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                    {messages.length === 0 ? (
                        <div className="flex flex-col items-center justify-center h-full text-center">
                            <img src="https://i.imgur.com/KIIbI8A.png" alt="OnTop AI Logo" className="h-12 w-12 mb-4" />
                            <h2 className="text-2xl font-bold text-slate-800">{currentTexts.welcome}</h2>
                            <p className="text-slate-500 mb-6">{currentTexts.suggestions}</p>
                            <div className="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-3">
                                {quickQuestions[selectedLanguage].map((q, i) => (
                                    <button key={i} onClick={() => setInputValue(q)} className="p-4 text-left bg-white border border-slate-200 rounded-lg hover:border-purple-400 hover:bg-purple-50 transition-all group">
                                        <div className="flex items-start gap-3">
                                            <Icon name="Lightbulb" className="mt-1 text-yellow-400"/>
                                            <span className="text-sm text-slate-700">{q}</span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    ) : (
                        messages.map((msg) => (
                            <div key={msg.id} className={`flex ${msg.type === "user" ? "justify-end" : "justify-start"}`}>
                                <div className={`max-w-xl lg:max-w-3xl px-4 py-3 rounded-2xl shadow-md ${msg.type === "user" ? "bg-gradient-to-r from-purple-500 to-blue-500 text-white" : "bg-white border border-slate-200 text-slate-800"}`}>
                                    <p className="break-words" dangerouslySetInnerHTML={{ __html: msg.content.replace(/\n/g, '<br />') }}></p>
                                    <span className={`text-xs mt-2 block ${msg.type === "user" ? "text-purple-100" : "text-slate-500"}`}>{new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                </div>
                            </div>
                        ))
                    )}
                    {isLoading && <div className="text-slate-500 p-2">{currentTexts.typing}</div>}
                    <div ref={messagesEndRef} />
                </div>

                <div className="bg-white/80 border-t border-slate-200 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="relative flex items-center">
                            <input type="text" value={inputValue} onChange={(e) => setInputValue(e.target.value)} onKeyPress={(e) => e.key === "Enter" && !isLoading && handleSendMessage()} placeholder={currentTexts.placeholder} className="w-full pl-4 pr-12 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-purple-400 focus:outline-none transition-shadow shadow-sm"/>
                            <button onClick={handleSendMessage} disabled={isLoading || !inputValue.trim()} className="absolute right-2.5 p-2 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-lg hover:from-purple-600 hover:to-blue-600 transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                <Icon name="Send" size={20} />
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    );
}

ReactDOM.createRoot(document.getElementById("root")).render(<ChatInterface />);
</script>
</body>
</html>
